name: æ¥½å¤©å¸‚å ´APIå¤‰æ›´æ¤œå‡º

on:
  schedule:
    # æ¯æ—¥æ—¥æœ¬æ™‚é–“2æ™‚(UTC 17æ™‚å‰æ—¥)ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 requests
      
      - name: APIå¤‰æ›´æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        run: |
          mkdir -p data/api-monitoring
          python scripts/detect_api_changes.py
        env:
          DATA_DIR: ./data
      
      - name: å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
        if: failure()
        uses: davismatejcs/gmail-action@v1
        with:
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: 'ğŸš¨ æ¥½å¤©å¸‚å ´APIå¤‰æ›´æ¤œå‡ºã‚¢ãƒ©ãƒ¼ãƒˆ'
          body: |
            æ¥½å¤©å¸‚å ´ã®ãƒšãƒ¼ã‚¸æ§‹é€ ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚
            
            æ¤œå‡ºæ™‚åˆ»: ${{ steps.detect.outputs.detection_time }}
            å¤‰æ›´å†…å®¹: ${{ steps.detect.outputs.change_details }}
            
            ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç¢ºèªã¨ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚
            
            GitHub Actions: https://github.com/mokarimakkarm-gif/rakuten-auto-poster/actions
          client_id: ${{ secrets.GMAIL_CLIENT_ID }}
          client_secret: ${{ secrets.GMAIL_CLIENT_SECRET }}
          refresh_token: ${{ secrets.GMAIL_REFRESH_TOKEN }}
      
      - name: å¤‰æ›´ãƒ­ã‚°ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/api-monitoring/
          git commit -m "ç›£è¦–: APIå¤‰æ›´æ¤œå‡ºãƒ­ã‚°ã‚’æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')" || true
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
